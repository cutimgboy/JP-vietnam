# 实时股票行情数据系统开发任务

- [x] 任务1：创建数据库实体和表结构
    - 1.1: 创建StockRealtimePriceEntity实体类，定义股票实时价格表结构
    - 1.2: 创建StockPriceChangeEntity实体类，定义股票价格变动记录表结构
    - 1.3: 更新app.module.ts，将新实体添加到TypeORM配置中
    - 1.4: 创建数据库迁移脚本，确保表结构正确创建

- [x] 任务2：扩展QuoteService实现价格变化检测和缓存
    - 2.1: 在QuoteService中添加Redis缓存依赖注入
    - 2.2: 实现价格变化检测逻辑，比较WebSocket数据与缓存中的价格
    - 2.3: 实现价差设置查询功能，从trading_settings表获取spread和askSpread
    - 2.4: 实现买卖价格计算逻辑（买入价=实时价格+spread，卖出价=实时价格-askSpread）
    - 2.5: 实现Redis缓存更新逻辑，存储计算后的买卖价格
    - 2.6: 实现数据库异步写入功能，记录价格变动历史

- [x] 任务3：创建Redis缓存服务扩展
    - 3.1: 在RedisService中添加股票价格缓存相关方法
    - 3.2: 实现批量获取股票行情数据的方法
    - 3.3: 实现设置和获取单个股票行情的方法
    - 3.4: 实现所有股票汇总数据的缓存方法
    - 3.5: 添加缓存TTL管理和过期清理逻辑

- [x] 任务4：实现QuoteController的实时行情API
    - 4.1: 创建获取所有股票实时行情的接口（GET /api/quote/realtime）
    - 4.2: 创建获取单个股票实时行情的接口（GET /api/quote/realtime/:code）
    - 4.3: 实现API响应格式，确保返回前端需要的codeList格式
    - 4.4: 添加错误处理和异常捕获机制
    - 4.5: 添加API文档注解（Swagger）

- [x] 任务5：优化WebSocket订阅和数据处理
    - 5.1: 修改QuoteService，确保只订阅指定的5只股票（NVDA.US, MSFT.US, AAPL.US, AMZN.US, GOOG.US）
    - 5.2: 优化数据去重逻辑，确保只有价格变化才触发处理
    - 5.3: 实现批量Redis更新操作，提高性能
    - 5.4: 添加系统监控和日志记录
    - 5.5: 实现故障恢复和重连机制

- [x] 任务6：系统测试和性能优化
    - 6.1: 创建单元测试，验证价格计算逻辑
    - 6.2: 创建集成测试，验证端到端数据流
    - 6.3: 进行性能测试，确保API响应时间<50ms
    - 6.4: 优化数据库查询和索引
    - 6.5: 优化Redis缓存策略和内存使用

- [x] 任务7：部署配置和文档完善
    - 7.1: 更新环境配置文件，添加相关配置项
    - 7.2: 完善API文档和使用说明
    - 7.3: 创建系统监控和告警配置
    - 7.4: 编写部署和维护文档
    - 7.5: 进行系统完整性测试
